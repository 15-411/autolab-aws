sudo apt-get update
sudo apt-get upgrade
sudo apt-get install make gcc python-pip nginx software-properties-common

pip install --upgrade pip
hash -r pip

curl -sL https://deb.nodesource.com/setup_10.x | sudo -E bash -
sudo apt-get install -y nodejs
sudo npm install -g concurrently

# add SSH public keys to ~ubuntu/.ssh/authorized_keys
# add private keys to ~ubuntu/411-17-ami.pem and github_key.pem
# add AWS credentials to ~ubuntu/.boto
chmod 400 411-17-ami.pem

wget http://download.redis.io/redis-stable.tar.gz
tar xvzf redis-stable.tar.gz
cd redis-stable
make
sudo make install

AUTOLAB_SCRIPT=`mktemp` && \curl -sSL https://raw.githubusercontent.com/CMU-15-411-F18/Autolab/master/bin/setup.sh > $AUTOLAB_SCRIPT && \bash $AUTOLAB_SCRIPT

# Edit the following configuration files:
# Autolab/config/autogradeConfig.rb
# Autolab/config/initializers/devise.rb (set config.mailer_sender)
# Autolab/config/environments/production.rb (create from production.template.rb)
# Autolab/config/database.yml
# Autolab/config/school.yml

# use the mysql command line to add the database and user
cd ~/Autolab
RAILS_ENV=production bundle exec rake db:reset
RAILS_ENV=production bundle exec rake db:migrate
RAILS_ENV=production bundle exec rake assets:precompile

# Copy ~/Autolab/config/environments/production.template.rb to production.rb
# In this file, change config.serve_static_files to true

git clone https://github.com/CMU-15-411-F18/Tango.git
pip install --user -r Tango/requirements.txt
# Create ~/Tango/config.py based on config.template.py

# add site config to /etc/nginx/sites_available/autolab (redirect to http://127.0.0.1:15411 using proxy_pass)
# enable site config by creating a symlink and restarting nginx:
sudo ln -s /etc/nginx/sites-available/autolab autolab
sudo service nginx restart

sudo add-apt-repository ppa:certbot/certbot
sudo apt-get update
sudo apt-get install python-certbot-nginx
sudo certbot --nginx

TO RUN:
screen -S redis
redis-server

screen -S tango
cd ~/Tango
concurrently -n jobManager,server "python jobManager.py" "python restful-tango/server.py"

screen -S autolab
cd ~/Autolab
bundle exec rails server -p 15411 -e production
